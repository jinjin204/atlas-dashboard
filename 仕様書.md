# Atlas Hub 共通仕様書 v1.0

## 1. カレンダーが動くために必須な「データの最小定義」

### Production Event JSON (最小構造)

カレンダーに生産イベントを表示するために、各イベントオブジェクトは以下の**全フィールド**を持たなければならない:

```json
{
    "title": "string (必須: 商品名 + 部位名)",
    "start": "string (必須: YYYY-MM-DD 形式の日付)",
    "color": "string (オプション: CSSカラーコード)",
    "extendedProps": {
        "details": "string (必須: ステータス表示文字列)",
        "project": "string (必須: 商品名)",
        "part":    "string (必須: 部位名。空文字可)",
        "confidence": "string (必須: 'high' or 'low')"
    }
}
```

### 必須フィールド一覧

| フィールド | 型 | 必須 | 用途 |
|---|---|---|---|
| `title` | string | ✅ | カレンダーセルに表示するラベル |
| `start` | string | ✅ | どの日付セルに配置するか（YYYY-MM-DD） |
| `extendedProps` | object | ✅ | 詳細情報のコンテナ |
| `extendedProps.confidence` | string | ✅ | 配色制御とアイコン選択に使用 |
| `extendedProps.details` | string | ✅ | ツールチップ表示 |
| `color` | string | ❌ | 未使用（将来拡張用） |

### CSV ログの必須カラム

`production_logic.py` が動作するために、入力CSVは以下のカラムを持つ必要がある:

| カラム名 | 型 | 用途 |
|---|---|---|
| `TIMESTAMP` | datetime | 日付の確定（唯一の日付ソース） |
| `PROJECT` | string | 商品名/プロジェクト名 |
| `PATH` | string | ファイルパス（表/裏判定用） |
| `PART` | string (任意) | 部位名（存在しない場合は空文字として処理） |

---

## 2. 不純データが混じった際の回避ロジック

### Python側 (app.py)

```
1. production_logic.py が生成した events リストを受け取る
2. 各イベントに (title, start, extendedProps) が存在するか検証
3. 不正なイベントはフィルタリングで除外
4. json.dumps() 後に json.loads() で構文検証（パラノイアチェック）
5. JSON生成に失敗した場合は "[]" にフォールバック
```

### JS側 (index.html ガードレール)

```
1. window.onload で PM オブジェクトの存在を確認
2. PM.productionEvents が配列であることを確認
3. 各イベントの必須フィールドを検証
4. 不正なイベントを自動除去し、console.warn() で報告
5. 致命的エラー時は #error-console に赤字で表示（真っ白にしない）
```

### フォールバックの連鎖

```
データ正常 → カレンダー正常表示
  ↓ 一部不正
不正イベント除去 → カレンダー表示（一部欠損）+ console.warn
  ↓ 全データ不正
空配列フォールバック → カレンダー表示（イベントなし）+ st.warning
  ↓ JS自体がクラッシュ
window.onerror → #error-console に赤字でエラー表示（真っ白防止）
```

---

## 3. 在庫連動プロトコル (Write-back)

### フロー
1. Stockタブで「✅ 在庫確定」ボタン押下
2. `update_master_inventory(item_name)` が実行
3. 楽観的ロック: Drive API で `modifiedTime` を事前取得
4. メニュー.xlsx をダウンロード → pandas で在庫+1
5. アップロード前に再度 `modifiedTime` をチェック
6. 不一致なら「⚠️ 競合エラー」で中止
7. 一致なら上書きアップロード + キャッシュクリア

### 安全装置
| レイヤー | 安全装置 |
|---|---|
| UI | 確認ボタン + spinner + success/error メッセージ |
| ロジック | 楽観的ロック (modifiedTime) |
| データ | 操作ログ出力 (変更前→変更後の値を記録) |
| フォールバック | Google Sheet形式の場合は書き込み拒否 |

---

## 4. データパイプライン完全性チェック

各段階で「次の段階に正しく渡っているか」を検証する。

| 段階 | 入力 | 出力 | 検証方法 |
|---|---|---|---|
| ① CNC → Atlas | 手動入力 | GAS POST | Atlas UIのステータス表示 |
| ② Atlas → スプレッドシート | GAS POST | 14カラムCSV | Inspector タブで確認 |
| ③ スプレッドシート → Calendar | Drive API → production_logic.py | productionEvents JSON | app.py のガードレール |
| ④ Calendar → Inventory | ユーザー確認 | update_master_inventory() | Stockタブの操作ログ |

