graph TD
    subgraph Cloud ["Google Drive (メニュー.xlsx)"]
        EM["1. イベントマスタ<br/>(アクティブ行 & 持越元を特定)"]
        BS["2. 初期在庫シート<br/>(例: クリマ2512 AK列)"]
        CS["3. 現在在庫シート<br/>(例: クリマ2605 G列)"]
        PM["4. 商品マスタ<br/>(目標数 & 各工程の加工時間)"]
    end

    subgraph Local ["Local Environment (.gemini/atlas-hub)"]
        ML["master_loader.py<br/>(データ収集・統合)"]
        HS[("history_summary.json<br/>(日次の全在庫スナップショット)")]
        ZC["zeus_chat.py<br/>(成果計算 & 未来予測)"]
    end

    %% データ収集
    EM & BS & CS & PM --> ML
    
    %% 記録と蓄積
    ML -- "5. 最新情報を追記" --> HS

    %% 成果計算 (Today vs Yesterday)
    HS -- "6. 前回ログとの差分" --> ZC
    ZC -- "★本日の成果報告" --> Result(["成果出力"])

    %% 未来予測 (Total Progress & Speed)
    BS & CS -.-> ZC
    PM -.-> ZC
    HS -- "7. 過去全ログから平均ペース算出" --> ZC
    
    ZC -- "8. 残工数 × ペース" --> Predict(["完了予定日の宣告"])

    style HS fill:#f96,stroke:#333,stroke-width:2px
    style Predict fill:#dfd,stroke:#333


    graph TD
    subgraph Files ["1. 入力ファイル (Data Sources)"]
        HS["history_summary.json<br/>(歴史・初期在庫)"]
        PM["production_master.json<br/>(工数マスタ・現在在庫)"]
        EM["event_master.json<br/>(締切・備考 生データ)"]
    end

    subgraph Python ["2. Pythonでの確定計算ロジック (zeus_chat.py)"]
        GetDates["A. 日付の動的取得<br/>・今日 = datetime.now<br/>・起点 = history[type:initial].date"]
        
        Merge["B. IDによる精密マージ<br/>(PM[id] == HS[initial].details[id])"]
        
        CalcWork["C. 不足工数の算出 (Pythonが完遂)<br/>Σ { (PM.target - PM.current) × PM.process_times }"]
        
        CalcPace["D. 生産ペースの算出<br/>(PM.total_current - HS[initial].total_current) / (今日 - 起点)"]
    end

    subgraph Prompt ["3. 軍師Zeusへの指令書 (System Prompt)"]
        Header["[最優先] 今日と起点の『日付』を明文化"]
        Calculated["[確定数値] Pythonが弾き出した工数とペース"]
        Raw["[生データ] イベントマスタを未加工で流し込み"]
    end

    %% 接合と計算の流れ
    HS & PM --> Merge
    Merge --> CalcWork
    Merge --> CalcPace
    GetDates --> Header
    CalcWork & CalcPace --> Calculated
    EM --> Raw

    style Merge fill:#f96,stroke:#333
    style Header fill:#dfd,stroke:#333
    style Raw fill:#bbf,stroke:#333
    