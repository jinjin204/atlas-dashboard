# Development Rules
## 1. Data Integrity (Pandas)
- **【最優先事項】** 列代入やマージを行う直前には、必ず `drop_duplicates(subset=['商品名'])` および `reset_index(drop=True)` を実行し、データの一意性を確定させよ。
- 実データには必ず「重複」「表記ゆれ」「空行」があると想定せよ。
- `fillna()` を標準装備し、処理の停止を回避せよ。
- 列名の検索は「完全一致」ではなく「キーワード部分一致」を優先せよ。

## 2. Environment
- 実行ポートは `8501` に固定。
- 仮想環境 `.venv` 内の Python を使用し、ライブラリ不足時は自動インストールを試みよ。

## 3. Security
- `credentials.json` や `token.json` のパスを動的に解決し、読み込み失敗時は具体的解決策を提示せよ。

## 4. Communication
- 技術的な議論が必要な場合は、黙って実装せず、ユーザーに構造的な提案（提言）を行うこと。日本語で。
- **Language Policy**: 内部思考やコード理解において英語を使用することは許容されるが、ユーザーへの回答、ドキュメント、コミットメッセージ、コード内の主要なコメントは必ず**日本語**で行うこと。これにより、ユーザーとの相互理解の精度を最大化する。

## UI・カレンダー実装ルール
- カレンダーは FullCalendar (JavaScript) を使用し、iframe (components.html) 内で完結させること。
- **ナビゲーションの保証**: `headerToolbar` に必ず `prev,next,today` を含め、ユーザーが自律的に月を移動できるようにすること。
- **ステートの維持**: Python側の再描画でカレンダーが「今日」に戻るバグを避けるため、`initialDate` は動的に管理するか、JS側でカレンダーの描画を最適化すること。
- **ブラックボックス化の禁止**: UIが「動かない」状態を防ぐため、JSの設定値（config）を app.py 内で明確に定義し、ユーザーがデバッグできるようにすること。

## 5. データパイプライン・ルール
- **Dead Code Detection**: 関数を書いたら、それを呼ぶ場所も同時に実装せよ。呼び出し元のない関数は存在しないのと同じ。
- **Write-back Safety**: マスタデータへの書き込みには必ず (1) 楽観的ロック (modifiedTime), (2) 操作ログ出力, (3) UI上の確認ダイアログを伴うこと。
- **パイプライン完全性**: Input → Log → Calendar → Inventory の各段階で「次の段階に正しく渡っているか」まで検証せよ。「表示できた」で完了としない。

## 6. No White Screen ルール
- JSの構文エラーで画面が真っ白になることは絶対に許容しない。
- `window.onerror` は常に正しいシグネチャで実装し、エラーがあれば `#error-console` に赤字で表示すること。
- データガードレール (JS側バリデーション) を常に有効にし、不正データは自動除去＋ `console.warn` で報告すること。
