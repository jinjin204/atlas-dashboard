# 実装計画書: Zeusロジック強化とマスタデータ動的読み込み

## 1. ゴール記述
イベントマスタ.csv（実態は `メニュー.xlsx` のシートを想定）を参照し、アクティブなイベントシートを動的に特定・ロードする仕組みを `master_loader.py` に実装する。
また、`zeus_chat.py` において、現在在庫だけでなく、履歴データに基づいた「実力（生産ペース）」と「予言（納期達成可否）」を回答できるようにし、回答フォーマットを yjing 向けに最適化する。

## 2. ユーザーレビューが必要な事項
- **イベントマスタの扱い**: `master_loader.py` は現在 `メニュー.xlsx` を読み込んでいるため、csvではなくExcelシートとして処理を進めます。もし個別のCSVファイルが存在・必須であればご指摘ください。
- **履歴データの保存先**: `data/history_summary.json` に保存します。
- **目標・在庫の列**: 対象シートの「F列」を目標、「G列」を現在在庫として読み込みます（列インデックス 5, 6）。これは固定仕様とします。

## 3. 提案される変更

### コンポーネント: データロード (`atlas-hub/logic/master_loader.py`)

#### [MODIFY] master_loader.py
- **イベント特定ロジックの修正**: `pd.read_excel` で `イベントマスタ` シートを読み、`表示フラグ` (または類似カラム) が True の行を抽出。
- **対象シート読み込み**: 特定されたシート名を読み込み、F列（目標）、G列（在庫）を取得して `production_master.json` に反映。
- **履歴初期化**: `data/history_summary.json` が未存在の場合、現在の集計結果を `type: "initial"` として保存する処理を追加。

### コンポーネント: Zeusチャット (`atlas-hub/logic/zeus_chat.py`)

#### [MODIFY] zeus_chat.py
- **履歴読み込み**: `data/history_summary.json` を読み込み、最新のスナップショットと比較。
- **計算ロジック追加**:
    - **【残量】**: $\sum(\text{目標}) - \sum(\text{現在在庫})$
    - **【実力】**: $(\text{現在在庫} - \text{前回在庫}) / (\text{現在日付} - \text{前回日付})$ の日次ペース（初回は0または計測不可）。
    - **【予言】**: $\text{現在日付} + (\text{残量} / \text{実力})$ が 2026-05-05 を超えるか判定。
- **プロンプト更新**:
    - ユーザー名を "yjing" に固定。
    - 出力構成を「現状」「予測」「次の一手」の3点に絞る指示追加。

## 4. 検証計画

### 自動テストスクリプトの作成
`tests/verify_zeus_logic.py` を作成し、以下の流れを検証する。
1. ダミーの `メニュー.xlsx` （イベントマスタ含む）を作成。
2. `master_loader.py` を実行し、`target_sheet` が正しく特定され、データがロードされるか確認。
3. `history_summary.json` が生成されるか確認。
4. `zeus_chat.py` のロジック関数（新規作成予定の計算関数）を呼び出し、残量・実力・予言の計算結果が正しいか検証。

### 手動検証
- アプリを起動し、Zeusに「現状はどう？」と問いかけ、指定フォーマットで回答が返るか確認。
