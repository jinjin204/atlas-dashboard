# ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã®è‡ªå‹•åŒ–ï¼ˆCSV to JSON Converterï¼‰

CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿JSONã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ `logic/master_loader.py` ã‚’æ–°è¦ä½œæˆã—ã€`app.py` ã«çµ±åˆã™ã‚‹ã€‚

## æ‰€æ„Ÿãƒ»æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼æç¤ºã®Geminiã‚³ãƒ¼ãƒ‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ä»¥ä¸‹ã®æ”¹å–„ã‚’åŠ ãˆã‚‹ï¼š

1. **æˆ»ã‚Šå€¤ã®å‹çµ±ä¸€**: ã‚¨ãƒ©ãƒ¼æ™‚ã« `dict` ã‚’è¿”ã™ç®‡æ‰€ã‚’ä¿®æ­£ã—ã€å¸¸ã« `list` ã‚’è¿”ã™ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºãƒªã‚¹ãƒˆ + ãƒ­ã‚°å‡ºåŠ›ï¼‰
2. **CSVãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€`data/` å†…ã®æœ€æ–°CSVã‚’è‡ªå‹•æ¤œç´¢
3. **ãƒ­ã‚®ãƒ³ã‚°**: `print` ã®ä»£ã‚ã‚Šã« `logging` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨
4. **æ—¢å­˜ã®Driveãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨ã®å…±å­˜**: ç¾åœ¨ã® `load_data_from_drive()` ã¯ãã®ã¾ã¾ç¶­æŒã—ã€`master_loader` ã¯ç‹¬ç«‹ã—ãŸæ©Ÿèƒ½ã¨ã—ã¦è¿½åŠ 

> [!IMPORTANT]
> ç¾åœ¨ `data/` ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ `confirmed_log.csv` ã®ã¿å­˜åœ¨ã—ã€**`ãƒ¡ãƒ‹ãƒ¥ãƒ¼.xlsx - å•†å“ãƒã‚¹ã‚¿.csv` ã¯å­˜åœ¨ã—ã¾ã›ã‚“**ã€‚ã“ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§é…ç½®ã™ã‚‹ã‹ã€åˆ¥é€”Google Driveã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å®Ÿè£…å¾Œã€CSVã‚’ `data/` ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚

---

## ææ¡ˆã™ã‚‹å¤‰æ›´

### logic ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### [NEW] [master_loader.py](file:///c:/Users/yjing/.gemini/atlas-hub/logic/master_loader.py)

ãƒ¦ãƒ¼ã‚¶ãƒ¼æç¤ºã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ä»¥ä¸‹ã®æ§‹æˆã§æ–°è¦ä½œæˆï¼š

- `CSV_PATH`, `JSON_PATH` å®šæ•°å®šç¾©
- `get_val(row, col, default)` / `get_str(row, col, default)` ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
- `find_latest_csv(directory)` â€” ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼š`data/` å†…ã§æœ€æ–°ã®CSVã‚’æ¤œç´¢
- `convert_csv_to_json(force=False)` â€” ãƒ¡ã‚¤ãƒ³å¤‰æ›é–¢æ•°
  - CSVãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ `data/` å†…ã®æœ€æ–°CSVã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  - å¤‰æ›ã—ãŸãƒªã‚¹ãƒˆã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—
  - æˆåŠŸæ™‚ã¯ãƒªã‚¹ãƒˆã€å¤±æ•—æ™‚ã¯ç©ºãƒªã‚¹ãƒˆã‚’è¿”ã™
- `load_master_json()` â€” JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§è¿”ã™é–¢æ•°ï¼ˆJSONãŒå¤ãã¦ã‚‚èª­ã‚ã‚‹è£œåŠ©ï¼‰

---

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ

#### [MODIFY] [app.py](file:///c:/Users/yjing/.gemini/atlas-hub/app.py)

**å¤‰æ›´1: importè¿½åŠ **ï¼ˆ10è¡Œç›®ä»˜è¿‘ï¼‰
```python
from logic.master_loader import convert_csv_to_json, load_master_json
```

**å¤‰æ›´2: èµ·å‹•æ™‚ã®è‡ªå‹•å¤‰æ›**ï¼ˆ126è¡Œç›®ä»˜è¿‘ã€Data Loading ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
```python
# --- Master Data (CSV â†’ JSON è‡ªå‹•å¤‰æ›) ---
if 'master_data' not in st.session_state:
    master_list = convert_csv_to_json()
    st.session_state['master_data'] = master_list
```

**å¤‰æ›´3: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã€ŒğŸ”„ ãƒã‚¹ã‚¿æ›´æ–°ã€ãƒœã‚¿ãƒ³**ï¼ˆ154è¡Œç›®ä»˜è¿‘ã€sidebar ãƒ–ãƒ­ãƒƒã‚¯å†…ï¼‰
```python
st.divider()
if st.button("ğŸ”„ ãƒã‚¹ã‚¿æ›´æ–°", use_container_width=True):
    with st.spinner("CSVã‹ã‚‰ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å†ç”Ÿæˆä¸­..."):
        master_list = convert_csv_to_json(force=True)
        st.session_state['master_data'] = master_list
    st.success(f"âœ… ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†ï¼ˆ{len(master_list)} ä»¶ï¼‰")
    st.rerun()
```

---

## æ¤œè¨¼è¨ˆç”»

### è‡ªå‹•ãƒ†ã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆç”¨CSVã‚’å‹•çš„ã«ä½œæˆã—ã€`convert_csv_to_json` ã®å‹•ä½œã‚’æ¤œè¨¼ã™ã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã€‚

```bash
python -m pytest tests/test_master_loader.py -v
```

ãƒ†ã‚¹ãƒˆå†…å®¹ï¼š
- æ­£å¸¸ãªCSVã‹ã‚‰ã®å¤‰æ›ã¨ JSONå‡ºåŠ›ã®ä¸­èº«æ¤œè¨¼
- CSVãŒå­˜åœ¨ã—ãªã„å ´åˆã®ç©ºãƒªã‚¹ãƒˆè¿”å´
- æ¬ æå€¤å‡¦ç†ï¼ˆ`NaN`, ç©ºæ–‡å­—ï¼‰ã®æ­£ç¢ºæ€§

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

1. `data/ãƒ¡ãƒ‹ãƒ¥ãƒ¼.xlsx - å•†å“ãƒã‚¹ã‚¿.csv` ã‚’é…ç½®
2. `streamlit run app.py` ã‚’èµ·å‹•
3. ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã€ŒğŸ”„ ãƒã‚¹ã‚¿æ›´æ–°ã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œ `data/production_master.json` ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
